# code: language=ansible
---
- name: Verify
  hosts: all
  gather_facts: false
  # check_mode: true
  become: true
  tasks:
    ## パッケージのテスト
    - name: Gather the package facts
      ansible.builtin.package_facts:
        manager: auto
    - name: Assert package
      ansible.builtin.assert:
        that:
          - ansible_facts.packages['opendkim'] is defined
          - ansible_facts.packages['opendkim-tools'] is defined
    ## ユーザーのテスト
    - name: Check user
      ansible.builtin.user:
        name: opendkim
        system: true
      register: user_check_result
      check_mode: true
    - name: Assert user
      ansible.builtin.assert:
        that:
          - user_check_result is not changed
    ## グループのテスト
    - name: Check group
      ansible.builtin.group:
        name: www-data
        system: true
      check_mode: true
      register: group_check_result
    - name: Assert group
      ansible.builtin.assert:
        that:
          - group_check_result is not changed
    # ファイルのテスト
    - name: Check KeyTable setting
      ansible.builtin.stat:
        path: /etc/opendkim/KeyTable
      register: result
    - name: Assert file
      ansible.builtin.assert:
        that:
          - result.stat.exists
    - name: Check SigningTable setting
      ansible.builtin.stat:
        path: /etc/opendkim/SigningTable
      register: result
    - name: Assert file
      ansible.builtin.assert:
        that:
          - result.stat.exists
    - name: Check TrustedHosts setting
      ansible.builtin.stat:
        path: /etc/opendkim/TrustedHosts
      register: result
    - name: Assert file
      ansible.builtin.assert:
        that:
          - result.stat.exists
    ## サービスのテスト
    - name: Populate service facts
      ansible.builtin.service_facts:
    - name: Assert service
      ansible.builtin.assert:
        that:
          - ansible_facts.services['opendkim.service'] is defined
          - ansible_facts.services['opendkim.service']['state'] == 'running'
          - ansible_facts.services['opendkim.service']['status'] == 'enabled'
